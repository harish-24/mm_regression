#!1 THP_TYPE: base shared_thp double_mapping pmd_split thp_split

. $TRDIR/lib/setup_thp_migration.sh

NR_THP=2

# <2019-03-01 Fri 13:53> temporary
ERROR_OFFSET=1

MAPTYPE=mmap_numa:preferred_cpu_node=0:preferred_mem_node=0
FORK=
SPLIT_THP=
HUGEPAGE_CHECKCODE=HUGEPAGE_NOT_MIGRATED
ACTION=memory_error_injection:error_type=soft-offline
ERROR_TYPE=soft-offline
ERROR_OFFSET=1 # offset 0 is unmapped via split pmd
HUGEANON="-B hugetlb_anon"
HUGETLB=200


#if __MARK_THP_TYPE == __MARK_THP_TYPE_shared_thp
FORK=fork:wait_after
#elif __MARK_THP_TYPE == __MARK_THP_TYPE_double_mapping
FORK=fork:wait_after
SPLIT_THP="split_thp:only_pmd"
#elif __MARK_THP_TYPE == __MARK_THP_TYPE_pmd_split
SPLIT_THP="split_thp:only_pmd"
#elif __MARK_THP_TYPE == __MARK_THP_TYPE_thp_split
SPLIT_THP="split_thp"
HUGETLB=0
HUGEANON=""
HUGEPAGE_CHECKCODE=HUGEPAGE_NOT_EXIST
#endif

TEST_PROGRAM="lib/test_alloc_generic $HUGEANON -B thp -N $NR_THP -L '$MAPTYPE access:wait_after $FORK $SPLIT_THP noop:wait_after $ACTION munmap:wait_before exit:wait_before'"
EXPECTED_RETURN_CODE="START INJECT MIGRATION_PASSED $HUGEPAGE_CHECKCODE EXIT"
